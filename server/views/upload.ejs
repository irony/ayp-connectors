<div class="container">
  <h1>Upload your library here</h1>

  <div class="hero-unit" ng-controller="UploadController"> 

    <h2>Select your photo library <small>(requires Chrome to select a whole folder)</small></h2>
    <input type="file" id="directoryinput" multiple webkitdirectory ng-model="selectedFolder" ng-change="fileChange">

    <h2>..or drop your photos or folders below</h2>
    <div id="dropzone" class="dropzone" dropzone>
      <ul>
        <li ng-repeat="file in files">{{file.name}} : {{file.state}}</li>
      </ul>

    </div>
    <a href="#" class="btn btn-success pull-right" ng-click="upload()">Upload</a>
  </div>

</div>

<script>
  //HTML5 Upload inspired by http://techslides.com
function UploadController($scope, $http){

  $scope.state = null;
  $scope.files = [];
  /* Drag'n drop stuff */


  //process files
  $scope.fileChange = function (e) {
    var files = e.target.files;
    for(i=0; i<files.length; i++) {
        var file = files[i];
        if(file.type.match(/image.*/)){
            $scope.files.push(file);
        }
    }
  };

  $scope.upload = function(){
    console.log('upload');
    $scope.files.forEach(function(file){
        queue(file);
    });
  };

  /* main upload function that sends images to imgur.com */
  function queue(file) {
    console.log('queued', file)
      file.state = 'Queued';
      /* Lets build a FormData object*/
      var fd = new FormData();
      
      fd.append(file.name, file);
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/upload", true);

      xhr.onload = function() {
        if(this.status>200){
          $scope.state = "error";
          file.state = 'Error';
          file.error = xhr.responseText;
        } else {
            var response = JSON.parse(xhr.responseText);
            file.response = response;
            file.state = 'Uploaded';
        }
      }

      // Listen to the upload progress.
      xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          file.progress = (e.loaded / e.total) * 100;
        }
      };


      xhr.send(fd);
  }


  

  
}
 
</script>