<!DOCTYPE html><html lang="en"><head><title>routes/photos</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/photos"><meta name="groc-project-path" content="server/routes/photos.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">server/routes/photos.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">ViewModel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./viewModel&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Photo</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/photo&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Group</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/group&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">){</span>

  <span class="kd">var</span> <span class="nx">s3UrlPrefix</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">global</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">bucket</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">global</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">datacenterUrl</span><span class="p">;</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/wall&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ViewModel</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">){</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;You have to login first&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;500.ejs&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;groups.ejs&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>

  <span class="p">});</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/photos/random/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;http://lorempixel.com/1723/900/people/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">Photo</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">owners</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;originalDownloaded&#39;</span><span class="p">).</span><span class="nx">ne</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">skip</span> <span class="o">||</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">limit</span> <span class="o">||</span> <span class="mi">50</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;-copies.&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s1">&#39;.interestingness&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">photos</span><span class="p">){</span>

      <span class="kd">var</span> <span class="nx">photo</span> <span class="o">=</span> <span class="nx">photos</span> <span class="o">&amp;&amp;</span> <span class="nx">photos</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">50</span><span class="p">)];</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">photo</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;http://lorempixel.com/1723/900/people/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span>
 
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/img/originals/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>

    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/photoFeed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ViewModel</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">),</span>
        <span class="nx">reverse</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">===</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
        <span class="nx">filter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">reverse</span><span class="p">)</span> <span class="o">?</span> <span class="p">{</span><span class="nx">$gte</span> <span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">startDate</span><span class="p">}</span> <span class="o">:</span> <span class="p">{</span><span class="nx">$lte</span> <span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">startDate</span><span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">){</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;You have to login first&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">maxRank</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">maxRank</span> <span class="o">||</span><span class="err"> </span><span class="mi">1500</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">limitRank</span> <span class="o">=</span> <span class="nx">maxRank</span> <span class="o">*</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">interestingness</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;searching photos:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span>

    <span class="nx">Photo</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;owners&#39;</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;taken&#39;</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;copies.&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s1">&#39;.hidden&#39;</span><span class="p">).</span><span class="nx">ne</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="c1">//.where(&#39;store.thumbnails.stored&#39;).exists()</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;copies.&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s1">&#39;.rank&#39;</span><span class="p">).</span><span class="nx">lte</span><span class="p">(</span><span class="nx">limitRank</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">reverse</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span><span class="o">:</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;taken&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">skip</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">limit</span> <span class="o">||</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">photos</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">photos</span> <span class="o">||</span><span class="err"> </span><span class="o">!</span><span class="nx">photos</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">photos</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;found %d photos&#39;</span><span class="p">,</span> <span class="nx">photos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>


      <span class="nx">photos</span> <span class="o">=</span> <span class="nx">photos</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">diffAverage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">last</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">a</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">b</span><span class="p">.</span><span class="nx">timeDiff</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">taken</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">taken</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
          <span class="nx">b</span><span class="p">.</span><span class="nx">diffTotal</span> <span class="o">=</span> <span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">diffTotal</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">timeDiff</span><span class="p">;</span>
          <span class="nx">diffAverage</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">diffTotal</span> <span class="o">/</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow at least half of the photos in the group.
And then only add photos which similar time diff compared to the rest of the photos
This is to prevent "horungar" from being added to a group</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">photos</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">||</span> <span class="nx">b</span><span class="p">.</span><span class="nx">timeDiff</span> <span class="o">&lt;</span> <span class="nx">diffAverage</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
      <span class="p">},</span> <span class="p">[]);</span>

      <span class="nx">async</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">photos</span> <span class="o">||</span> <span class="p">[]),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">photo</span><span class="p">,</span> <span class="nx">done</span><span class="p">){</span>

        <span class="k">delete</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">copies</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">].</span><span class="nx">_id</span><span class="p">;</span> <span class="c1">// the _id of the subdocument shouldn&#39;t replace the id of the photo</span>
        <span class="nx">photo</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">photo</span><span class="p">,</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">copies</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">]);</span> <span class="c1">// only use this user&#39;s personal settings</span>

        <span class="k">delete</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">copies</span><span class="p">;</span> <span class="c1">// and remove all other copies</span>
        <span class="k">delete</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">metadata</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">photo</span><span class="p">.</span><span class="nx">mimeType</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;video&#39;</span><span class="p">){</span>
          <span class="nx">photo</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">s3UrlPrefix</span> <span class="o">+</span> <span class="s1">&#39;/originals/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">photo</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">photo</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">store</span> <span class="o">&amp;&amp;</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">thumbnails</span> <span class="o">?</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">thumbnails</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span><span class="err"> </span><span class="s1">&#39;/img/thumbnails/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">photo</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">          var filename = path.resolve(&#39;/thumbnails/&#39; + photo.source + &#39;/&#39; + photo._id);</span>
<span class="cm">          global.s3.get(filename).on(&#39;response&#39;, function(res){</span>
<span class="cm">            if (res.statusCode != 200 )</span>
<span class="cm">              return done(null, photo);</span>

<span class="cm">            var buffer = &#39;&#39;;</span>
<span class="cm">            res.on(&#39;data&#39;, function(data) {</span>
<span class="cm">              buffer += data.toString(&#39;base64&#39;);</span>
<span class="cm">            });</span>
<span class="cm">            res.on(&#39;end&#39;, function(){</span>
<span class="cm">              photo.src = !buffer.length ? photo.src : &#39;data:&#39; + photo.mimeType + &#39;;base64,&#39; + buffer;</span>
<span class="cm">              return done(null, photo);</span>
<span class="cm">            });</span>
<span class="cm">          }).end();</span>
<span class="cm">*/</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">photos</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">photos</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/photoRange&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">startDate</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">dateRange</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">stopDate</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">dateRange</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
    <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ViewModel</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">){</span>
      <span class="nx">model</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;You have to login first&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;500.ejs&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">dateRange</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">Photo</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;owners&#39;</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;taken&#39;</span><span class="p">).</span><span class="nx">gte</span><span class="p">(</span><span class="nx">startDate</span><span class="p">).</span><span class="nx">lte</span><span class="p">(</span><span class="nx">stopDate</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">&#39;-taken&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">photos</span><span class="p">){</span>

      <span class="nx">async</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">photos</span> <span class="o">||</span> <span class="p">[]),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">photo</span><span class="p">,</span> <span class="nx">done</span><span class="p">){</span>
        <span class="nx">photo</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">photo</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">store</span> <span class="o">&amp;&amp;</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">thumbnails</span> <span class="o">&amp;&amp;</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">thumbnails</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span><span class="err"> </span><span class="s1">&#39;/img/thumbnails/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">photo</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">photo</span><span class="p">);</span>
      <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">photos</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">photos</span><span class="p">);</span>
      <span class="p">});</span>


    <span class="p">});</span>
  <span class="p">});</span>


<span class="p">};</span></div></div></div></div></body></html>